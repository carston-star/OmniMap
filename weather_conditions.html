<!-- Old Weather API: weatherstack.com 5fc72a1b0124b1f29f165db6357ae6e3     (check: 5fc72a1b0124b1f29f165db6357ae6e3) -->
<!-- New Weather API: OpenWeather.org API 124eb090e88356c238f27b5aa0855d13 -->
 
<!DOCTYPE html>
<html lang="en">
<head>
  <title>Weather Conditions</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="style_weather_conditions.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
</head>
<body>
  <header>
    <h1>Weather Conditions</h1>
    <nav>
      <ul style="list-style: none; display: flex; justify-content: center; padding: 0; margin: 0;">
        <li style="margin: 0 15px;"><a href="index2.html" style="text-decoration: none; color: white;">Home</a></li>
        <li style="margin: 0 15px;"><a href="weather_conditions.html" style="text-decoration: none; color: white;">Weather</a></li>
      </ul>
    </nav>
  </header>
  <div id="map" style="height: calc(100vh - 100px);"></div>
  <script>
    const map = L.map('map').setView([37.8, -96], 4.5);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      maxZoom: 19
    }).addTo(map);

    const icons = {
      beef: L.icon({
        iconUrl: 'Images/cow.png',
        iconSize: [30, 35],
        iconAnchor: [15, 35],
        popupAnchor: [0, -30]
      }),
      pork: L.icon({
        iconUrl: 'Images/pig.png',
        iconSize: [30, 35],
        iconAnchor: [15, 35],
        popupAnchor: [0, -30]
      }),
      poultry: L.icon({
        iconUrl: 'Images/turkey.png',
        iconSize: [30, 35],
        iconAnchor: [15, 35],
        popupAnchor: [0, -30]
      }),
      hq: L.icon({
        iconUrl: 'Images/HQ.png',
        iconSize: [30, 30],
        iconAnchor: [15, 30],
        popupAnchor: [0, -30]
      }),
      saas: L.icon({
        iconUrl: 'Images/HQ.png',
        iconSize: [15, 15], // 50% of hq icon size
        iconAnchor: [7.5, 15], // Adjusted anchor
        popupAnchor: [0, -15] // Adjusted popup anchor
      })
    };

    const locations = [
      { name: 'Amarillo', coords: [35.4127458, -101.654053], type: 'beef' },
      { name: 'Dakota City', coords: [42.478832, -96.413133], type: 'beef' },
      { name: 'Finney County', coords: [37.9983271, -101.0285989], type: 'beef' },
      { name: 'Green Bay', coords: [44.5282995, -88.0901618], type: 'beef' },
      { name: 'Joslin', coords: [41.555850, -90.225245], type: 'beef' },
      { name: 'Lexington', coords: [40.761108, -99.735229], type: 'beef' },
      { name: 'Omaha', coords: [41.2093464, -95.9701349], type: 'beef' },
      { name: 'Pasco', coords: [46.1375306, -118.9156132], type: 'beef' },
      { name: 'Plainwell', coords: [42.4211736, -85.6497604], type: 'beef' },
      { name: 'Smithfield', coords: [34.7545191, -78.8070153], type: 'pork' },
      { name: 'Souderton', coords: [40.2712296, -75.3361326], type: 'beef' },
      { name: 'Storm Lake', coords: [42.6392091, -95.1846581], type: 'poultry' },
      { name: 'Tolleson', coords: [33.4411955, -112.2553217], type: 'beef' },
      { name: 'Omnisharp', coords: [30.4604802, -97.6551371], type: 'hq' },
      { name: 'CES SaaS', coords: [53.4722462, -2.3793467], type: 'saas' },
      { name: 'Springdale', coords: [36.1907351, -94.4742007], type: 'saas' },
      { name: 'Keken', coords: [20.9861173, -89.7936814], type: 'pork' },
      { name: 'Proan', coords: [20.6740117, -103.4179727], type: 'pork' },
      { name: 'SuKarne', coords: [25.3220694, -104.908717], type: 'beef' },
      { name: 'CIM', coords: [39.0929534, -95.6437779], type: 'saas'}, // Shawn ks
      { name: 'FS', coords: [38.62763214111328, -90.19908905029297], type: 'saas'}, // Matt mo, shift+alt+downarrow
      { name: 'Sales', coords: [39.7392364, -104.984862], type: 'saas'}, // Rich aurora, co
      { name: 'Sales', coords: [38.883567810058594, -94.81935119628906], type: 'saas'}, // Monty olathe, ks
      { name: 'Sales', coords: [33.018917083740234, -80.17584228515625], type: 'saas'}, // Candice sommerville, sc
      { name: 'Sales', coords: [41.8755616, -87.6244212], type: 'saas'} // Dan chicago, il
      ];

    const OPENWEATHER_API_KEY = "124eb090e88356c238f27b5aa0855d13"; // Replace with your OpenWeather API key

    async function fetchWeather(location) {
      // Using OpenWeatherMap One Call API 3.0 (requires subscription, using free 2.5 for now)
      // Note: Free tier might not provide daily min/max reliably for all locations or future dates.
      // Using 5 day / 3 hour forecast endpoint as a fallback for daily min/max
      const lat = location.coords[0];
      const lon = location.coords[1];
      const response = await fetch(`https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&appid=${OPENWEATHER_API_KEY}&units=imperial`); // units=imperial for Fahrenheit
      const data = await response.json();

      if (data && data.list && data.list.length > 0) {
        // Find min and max temps for the next 24 hours (approximating daily)
        let minTemp = Infinity;
        let maxTemp = -Infinity;
        const now = Date.now();
        const twentyFourHoursLater = now + 24 * 60 * 60 * 1000;

        data.list.forEach(item => {
          const itemTime = item.dt * 1000;
          if (itemTime >= now && itemTime <= twentyFourHoursLater) {
            if (item.main.temp_min < minTemp) {
              minTemp = item.main.temp_min;
            }
            if (item.main.temp_max > maxTemp) {
              maxTemp = item.main.temp_max;
            }
          }
        });

        // If we couldn't find temps in the next 24h, use the first available forecast
        if (minTemp === Infinity || maxTemp === -Infinity) {
            minTemp = data.list[0].main.temp_min;
            maxTemp = data.list[0].main.temp_max;
        }

        return {
          low: Math.round(minTemp), // Daily low
          high: Math.round(maxTemp) // Daily high
        };
      } else {
        console.error(`Failed to fetch weather for ${location.name}:`, data);
        return null;
      }
    }

    async function addMarkers() {
      for (const location of locations) {
        const weather = await fetchWeather(location);
        const weatherLabel = weather
          ? `L ${weather.low}° / H ${weather.high}°`
          : `L -- / H --`;

        const customIcon = L.divIcon({
          className: 'custom-icon', // Keep the main class for potential existing styles
          html: `
            <div class="marker-container marker-type-${location.type}">
              <div class="site-name">${location.name}</div>
              <img src='${icons[location.type].options.iconUrl}' class="site-icon" />
              <div class="temperature-info">${weatherLabel}</div>
            </div>
          `,
          iconSize: [80, 80],  // Increased size to accommodate text
          iconAnchor: [40, 40]  // Centered anchor point
        });

        L.marker(location.coords, { icon: customIcon }).addTo(map);
      }
    }

    addMarkers();
  </script>
</body>
</html>
